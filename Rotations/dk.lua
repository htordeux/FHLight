
--[[[
@module Deathknight
@description
Deathknight Spells.
GENERATED FROM WOWHEAD SPELLS - DO NOT EDIT MANUALLY
]]--

jps.spells.deathknight = {}
jps.spells.deathknight.pathOfFrost = jps.toSpellName(3714)
jps.spells.deathknight.armyOfTheDead = jps.toSpellName(42650)
jps.spells.deathknight.deathAndDecay = jps.toSpellName(43265)
jps.spells.deathknight.chainsOfIce = jps.toSpellName(45524)
jps.spells.deathknight.raiseDead = jps.toSpellName(46584)
jps.spells.deathknight.mindFreeze = jps.toSpellName(47528)
jps.spells.deathknight.deathCoil = jps.toSpellName(47541)
jps.spells.deathknight.empowerRuneWeapon = jps.toSpellName(47568)
jps.spells.deathknight.veteranOfTheThirdWar = jps.toSpellName(48263)
jps.spells.deathknight.deathsAdvance = jps.toSpellName(48265)
jps.spells.deathknight.antimagicShell = jps.toSpellName(48707)
jps.spells.deathknight.iceboundFortitude = jps.toSpellName(48792)
jps.spells.deathknight.obliterate = jps.toSpellName(49020)
jps.spells.deathknight.dancingRuneWeapon = jps.toSpellName(49028)
jps.spells.deathknight.frostStrike = jps.toSpellName(49143)
jps.spells.deathknight.howlingBlast = jps.toSpellName(49184)
jps.spells.deathknight.summonGargoyle = jps.toSpellName(49206)
jps.spells.deathknight.suddenDoom = jps.toSpellName(49530)
jps.spells.deathknight.deathGrip = jps.toSpellName(49576)
jps.spells.deathknight.deathStrike = jps.toSpellName(49998)
jps.spells.deathknight.bloodBoil = jps.toSpellName(50842)
jps.spells.deathknight.deathGate = jps.toSpellName(50977)
jps.spells.deathknight.killingMachine = jps.toSpellName(51128)
jps.spells.deathknight.pillarOfFrost = jps.toSpellName(51271)
jps.spells.deathknight.runicCorruption = jps.toSpellName(51462)
jps.spells.deathknight.onAPaleHorse = jps.toSpellName(51986)
jps.spells.deathknight.runeOfRazorice = jps.toSpellName(53343)
jps.spells.deathknight.runeOfTheFallenCrusader = jps.toSpellName(53344)
jps.spells.deathknight.runeforging = jps.toSpellName(53428)
jps.spells.deathknight.bloodPlague = jps.toSpellName(55078)
jps.spells.deathknight.scourgeStrike = jps.toSpellName(55090)
jps.spells.deathknight.frostFever = jps.toSpellName(55095)
jps.spells.deathknight.vampiricBlood = jps.toSpellName(55233)
jps.spells.deathknight.darkCommand = jps.toSpellName(56222)
jps.spells.deathknight.hornOfWinter = jps.toSpellName(57330)
jps.spells.deathknight.glyphOfTheGeist = jps.toSpellName(58640)
jps.spells.deathknight.glyphOfFoulMenagerie = jps.toSpellName(58642)
jps.spells.deathknight.rime = jps.toSpellName(59057)
jps.spells.deathknight.raiseAlly = jps.toSpellName(61999)
jps.spells.deathknight.runeOfTheStoneskinGargoyle = jps.toSpellName(62158)
jps.spells.deathknight.darkTransformation = jps.toSpellName(63560)
jps.spells.deathknight.masteryBloodShield = jps.toSpellName(77513)
jps.spells.deathknight.masteryFrozenHeart = jps.toSpellName(77514)
jps.spells.deathknight.masteryDreadblade = jps.toSpellName(77515)
jps.spells.deathknight.outbreak = jps.toSpellName(77575)
jps.spells.deathknight.crimsonScourge = jps.toSpellName(81136)
jps.spells.deathknight.runicEmpowerment = jps.toSpellName(81229)
jps.spells.deathknight.festeringStrike = jps.toSpellName(85948)
jps.spells.deathknight.asphyxiate = jps.toSpellName(108194)
jps.spells.deathknight.gorefiendsGrasp = jps.toSpellName(108199)
jps.spells.deathknight.controlUndead = jps.toSpellName(111673)
jps.spells.deathknight.purgatory = jps.toSpellName(114556)
jps.spells.deathknight.corpseExplosion = jps.toSpellName(127344)
jps.spells.deathknight.soulReaper = jps.toSpellName(130736)
jps.spells.deathknight.glyphOfTheSkeleton = jps.toSpellName(146652)
jps.spells.deathknight.breathOfSindragosa = jps.toSpellName(152279)
jps.spells.deathknight.defile = jps.toSpellName(152280)
jps.spells.deathknight.riposte = jps.toSpellName(161797)
jps.spells.deathknight.darkSuccor = jps.toSpellName(178819)
jps.spells.deathknight.coldAsIce = jps.toSpellName(189080)
jps.spells.deathknight.blastRadius = jps.toSpellName(189086)
jps.spells.deathknight.ambidexterity = jps.toSpellName(189092)
jps.spells.deathknight.overpowered = jps.toSpellName(189097)
jps.spells.deathknight.nothingButTheBoots = jps.toSpellName(189144)
jps.spells.deathknight.badToTheBone = jps.toSpellName(189147)
jps.spells.deathknight.iceInYourVeins = jps.toSpellName(189154)
jps.spells.deathknight.deadOfWinter = jps.toSpellName(189164)
jps.spells.deathknight.frozenCore = jps.toSpellName(189179)
jps.spells.deathknight.mirrorBall = jps.toSpellName(189180)
jps.spells.deathknight.frozenSoul = jps.toSpellName(189184)
jps.spells.deathknight.hypothermia = jps.toSpellName(189185)
jps.spells.deathknight.crystallineSwords = jps.toSpellName(189186)
jps.spells.deathknight.sindragosasFury = jps.toSpellName(190778)
jps.spells.deathknight.frostBreath = jps.toSpellName(190780)
jps.spells.deathknight.deadliestCoil = jps.toSpellName(191419)
jps.spells.deathknight.rottenTouch = jps.toSpellName(191442)
jps.spells.deathknight.plaguebearer = jps.toSpellName(191485)
jps.spells.deathknight.theDarkestCrusade = jps.toSpellName(191488)
jps.spells.deathknight.scourgeTheUnbeliever = jps.toSpellName(191494)
jps.spells.deathknight.deadlyDurability = jps.toSpellName(191565)
jps.spells.deathknight.unholyEndurance = jps.toSpellName(191584)
jps.spells.deathknight.runicTattoos = jps.toSpellName(191592)
jps.spells.deathknight.portalToTheUnderworld = jps.toSpellName(191637)
jps.spells.deathknight.gravitationalPull = jps.toSpellName(191721)
jps.spells.deathknight.armiesOfTheDamned = jps.toSpellName(191731)
jps.spells.deathknight.doubleDoom = jps.toSpellName(191741)
jps.spells.deathknight.scourgeOfWorlds = jps.toSpellName(191747)
jps.spells.deathknight.theShambler = jps.toSpellName(191760)
jps.spells.deathknight.grimPerseverance = jps.toSpellName(192447)
jps.spells.deathknight.ironHeart = jps.toSpellName(192450)
jps.spells.deathknight.meatShield = jps.toSpellName(192453)
jps.spells.deathknight.veinrender = jps.toSpellName(192457)
jps.spells.deathknight.coagulopathy = jps.toSpellName(192460)
jps.spells.deathknight.allconsumingRot = jps.toSpellName(192464)
jps.spells.deathknight.danceOfDarkness = jps.toSpellName(192514)
jps.spells.deathknight.bonebreaker = jps.toSpellName(192538)
jps.spells.deathknight.vampiricFangs = jps.toSpellName(192542)
jps.spells.deathknight.bloodFeast = jps.toSpellName(192548)
jps.spells.deathknight.rattlingBones = jps.toSpellName(192557)
jps.spells.deathknight.skeletalShattering = jps.toSpellName(192558)
jps.spells.deathknight.unendingThirst = jps.toSpellName(192567)
jps.spells.deathknight.mouthOfHell = jps.toSpellName(192570)
jps.spells.deathknight.umbilicusEternus = jps.toSpellName(193213)
jps.spells.deathknight.rapidDecomposition = jps.toSpellName(194662)
jps.spells.deathknight.runeTap = jps.toSpellName(194679)
jps.spells.deathknight.bonestorm = jps.toSpellName(194844)
jps.spells.deathknight.icyTalons = jps.toSpellName(194878)
jps.spells.deathknight.frozenPulse = jps.toSpellName(194909)
jps.spells.deathknight.gatheringStorm = jps.toSpellName(194912)
jps.spells.deathknight.glacialAdvance = jps.toSpellName(194913)
jps.spells.deathknight.allWillServe = jps.toSpellName(194916)
jps.spells.deathknight.pestilentPustules = jps.toSpellName(194917)
jps.spells.deathknight.blightedRuneWeapon = jps.toSpellName(194918)
jps.spells.deathknight.marrowrend = jps.toSpellName(195182)
jps.spells.deathknight.deathsCaress = jps.toSpellName(195292)
jps.spells.deathknight.bloodworms = jps.toSpellName(195679)
jps.spells.deathknight.remorselessWinter = jps.toSpellName(196770)
jps.spells.deathknight.festeringWound = jps.toSpellName(197147)
jps.spells.deathknight.shadowInfusion = jps.toSpellName(198943)
jps.spells.deathknight.frozenSkin = jps.toSpellName(204875)
jps.spells.deathknight.chillOfTheGrave = jps.toSpellName(205209)
jps.spells.deathknight.consumption = jps.toSpellName(205223)
jps.spells.deathknight.redThirst = jps.toSpellName(205723)
jps.spells.deathknight.antimagicBarrier = jps.toSpellName(205727)
jps.spells.deathknight.heartStrike = jps.toSpellName(206930)
jps.spells.deathknight.blooddrinker = jps.toSpellName(206931)
jps.spells.deathknight.markOfBlood = jps.toSpellName(206940)
jps.spells.deathknight.trembleBeforeMe = jps.toSpellName(206960)
jps.spells.deathknight.willOfTheNecropolis = jps.toSpellName(206967)
jps.spells.deathknight.tighteningGrasp = jps.toSpellName(206970)
jps.spells.deathknight.foulBulwark = jps.toSpellName(206974)
jps.spells.deathknight.bloodMirror = jps.toSpellName(206977)
jps.spells.deathknight.murderousIntent = jps.toSpellName(207018)
jps.spells.deathknight.shatteringStrikes = jps.toSpellName(207057)
jps.spells.deathknight.freezingFog = jps.toSpellName(207060)
jps.spells.deathknight.murderousEfficiency = jps.toSpellName(207061)
jps.spells.deathknight.runicAttenuation = jps.toSpellName(207104)
jps.spells.deathknight.icecap = jps.toSpellName(207126)
jps.spells.deathknight.hungeringRuneWeapon = jps.toSpellName(207127)
jps.spells.deathknight.avalanche = jps.toSpellName(207142)
jps.spells.deathknight.abominationsMight = jps.toSpellName(207161)
jps.spells.deathknight.blindingSleet = jps.toSpellName(207167)
jps.spells.deathknight.winterIsComing = jps.toSpellName(207170)
jps.spells.deathknight.volatileShielding = jps.toSpellName(207188)
jps.spells.deathknight.permafrost = jps.toSpellName(207200)
jps.spells.deathknight.frostscythe = jps.toSpellName(207230)
jps.spells.deathknight.obliteration = jps.toSpellName(207256)
jps.spells.deathknight.burstingSores = jps.toSpellName(207264)
jps.spells.deathknight.ebonFever = jps.toSpellName(207269)
jps.spells.deathknight.infectedClaws = jps.toSpellName(207272)
jps.spells.deathknight.unholyFrenzy = jps.toSpellName(207289)
jps.spells.deathknight.castigator = jps.toSpellName(207305)
jps.spells.deathknight.clawingShadows = jps.toSpellName(207311)
jps.spells.deathknight.sludgeBelcher = jps.toSpellName(207313)
jps.spells.deathknight.debilitatingInfestation = jps.toSpellName(207316)
jps.spells.deathknight.epidemic = jps.toSpellName(207317)
jps.spells.deathknight.corpseShield = jps.toSpellName(207319)
jps.spells.deathknight.spellEater = jps.toSpellName(207321)
jps.spells.deathknight.necrosis = jps.toSpellName(207346)
jps.spells.deathknight.darkArbiter = jps.toSpellName(207349)
jps.spells.deathknight.eternalAgony = jps.toSpellName(208598)
jps.spells.deathknight.spectralDeflection = jps.toSpellName(211078)
jps.spells.deathknight.artificialStamina = jps.toSpellName(211309)
jps.spells.deathknight.glyphOfCrackedIce = jps.toSpellName(212524)
jps.spells.deathknight.glyphOfDryIce = jps.toSpellName(212526)
jps.spells.deathknight.wraithWalk = jps.toSpellName(212552)
jps.spells.deathknight.soulgorge = jps.toSpellName(212744)
jps.spells.deathknight.lingeringApparition = jps.toSpellName(212763)
jps.spells.deathknight.whiteWalker = jps.toSpellName(212765)
jps.spells.deathknight.theHungeringMaw = jps.toSpellName(214903)
jps.spells.deathknight.soulbiter = jps.toSpellName(214904)
jps.spells.deathknight.fleshsearer = jps.toSpellName(214906)
jps.spells.deathknight.feastOfSouls = jps.toSpellName(218280)
jps.spells.deathknight.bladesOfFrost = jps.toSpellName(218931)
jps.spells.deathknight.glyphOfTheCrimsonShell = jps.toSpellName(218979)
jps.spells.deathknight.glyphOfTheChilledShell = jps.toSpellName(218989)
jps.spells.deathknight.glyphOfTheBloodWraith = jps.toSpellName(219000)
jps.spells.deathknight.glyphOfTheUnholyWraith = jps.toSpellName(219007)
jps.spells.deathknight.glyphOfTheWraithWalker = jps.toSpellName(219011)
jps.spells.deathknight.marchOfTheDamned = jps.toSpellName(219779)
jps.spells.deathknight.ossuary = jps.toSpellName(219786)
jps.spells.deathknight.tombstone = jps.toSpellName(219809)
jps.spells.deathknight.apocalypse = jps.toSpellName(220143)
jps.spells.deathknight.heartbreaker = jps.toSpellName(221536)
jps.spells.deathknight.bloodTap = jps.toSpellName(221699)
jps.spells.deathknight.sanguinaryAffinity = jps.toSpellName(221775)
jps.spells.deathknight.artificialDamage = jps.toSpellName(226829)
jps.spells.deathknight.bloodShield = jps.toSpellName(77535)
jps.spells.deathknight.boneShield = jps.toSpellName(195181)
jps.spells.deathknight.suddenDoom = jps.toSpellName(81340)
jps.spells.deathknight.virulentPlague = jps.toSpellName(191587)
jps.spells.deathknight.festeringWound = jps.toSpellName(194310)

--------------------------------
-- RUNES -----------------------
--------------------------------

-- start, duration, runeReady = GetRuneCooldown(id)
-- count = GetRuneCount(slot)
-- Returns 1 if a rune is ready and 0 if a rune is on cooldown.
-- runeType = GetRuneType(slot)
-- Returns Type of the rune (number)
-- 1 - Blood rune
-- 2 - Unholy rune
-- 3 - Frost rune
-- 4 - Death rune

function jps.runeCooldown(id)
	local runeCD = 0
	local start,duration,ready = GetRuneCooldown(id)
	if not ready then
		runeCD = start + duration - GetTime()
	end
	return runeCD
end

function jps.updateRune()
	local dr1 = GetRuneCount(1) -- 1 Leftmost -- blood rune or death rune
	local dr2 = GetRuneCount(2) -- 2 Second from left -- blood rune or death rune
	local ur1 = GetRuneCount(3) -- 3 Fifth from left (second from right) -- unholy rune
	local ur2 = GetRuneCount(4) -- 4 Sixth from left (rightmost) -- unholy rune
	local fr1 = GetRuneCount(5) -- 5 Third from left -- frost rune
	local fr2 = GetRuneCount(6) -- 6 Fourth from left -- frost rune
	
	local Dr = dr1 + dr2
	local Fr = fr1 + fr2
	local Ur = ur1 + ur2

	return Dr, Fr, Ur
end

function jps.updateDeathRune()
	local DeathRuneCount = 0
	for i=1,6 do
		local DeathRune = GetRuneType(i)
		local RuneReady = GetRuneCount(i)
		if DeathRune == 4 then
			if RuneReady == 1 then
				DeathRuneCount = DeathRuneCount + 1
			end
		end
	end
	return DeathRuneCount
end

function jps.Runes(rune)

	local Dr,Fr,Ur = jps.updateRune()
	local DepletedRunes = (Dr == 0) or (Fr == 0) or (Ur == 0)
	local CompletedRunes = (Dr > 0) and (Fr > 0) and (Ur > 0)
	local RuneCount = Dr + Fr + Ur
	local DeathRuneCount = dk.updateDeathRune()
	local RunesCD = 0
	for i=1,6 do
		local cd = dk.runeCooldown(i)
		RunesCD = RunesCD + cd
	end

	local runeTable = {
		["Dr"] = Dr,
		["Fr"] = Fr,
		["Ur"] = Ur,		
		["DepletedRunes"] = DepletedRunes,
		["CompletedRunes"] = CompletedRunes,
		["RuneCount"] = RuneCount,		
		["DeathRuneCount"] = DeathRuneCount,
		["RunesCD"] = RunesCD,
	}

	local result = 0
	if rune == "Dr" then result = Dr
	elseif rune == "Fr" then result = Fr
	elseif rune == "Ur" then result = Ur
	elseif rune == "DepletedRunes" then result = DepletedRunes
	elseif rune == "CompletedRunes" then result = CompletedRunes
	elseif rune == "RuneCount" then result = RuneCount
	elseif rune == "DeathRuneCount" then result = DeathRuneCount
	elseif rune == "RunesCD" then result = RunesCD
	end
	return runeTable[rune]
end

--------------------------------
-- FUNCTIONS
--------------------------------

local darkSimSpells = {
-- pvp
"Hex","Mind Control","Cyclone","Polymorph","Pyroblast","Tranquility","Divine Hymn","Ring of Frost","Entangling Roots",
"Maléfice","Contrôle mental","Cyclone","Métamorphose","Explosion pyrotechnique","Tranquillité","Hymne divin","Anneau de givre","Sarments"
}

function jps.shoulDarkSimUnit(unit)
	local darkSimSpell = false
	for i=1,#darkSimSpells do -- for _,spellName in ipairs(darkSimSpells) do
		local spellName = darkSimSpells[i]
		if jps.IsCastingSpell(spellName, unit) then 
			darkSimSpell = true
		elseif jps.IsChannelingSpell(spellName, unit) then 
			darkSimSpell = true
		break end
	end
	return darkSimSpell
end

function jps.shouldDarkSimTarget()
	return jps.shoulDarkSimUnit("target")
end

function jps.shouldDarkSimFocus()
	return jps.shoulDarkSimUnit("focus")
end

-- debuff Frost Fever 55095 -- debuff Blood Plague 55078
--"Outbreak" 77575 "Poussée de fièvre"
function jps.canCastPlagueLeech(timeLeft)
	if timeLeft == nil then timeLeft = 15 end
	if not jps.myDebuff(55095) then return false end
	if not jps.myDebuff(55078) then return false end
	if jps.myDebuffDuration(55078) < timeLeft then
		return true
	end
	return true
end

function jps.hasGhoul()
	if jps.Spec == "Unholy" then
		if UnitExists("pet") == nil then return false end
	else
		if select(1,GetTotemInfo(1)) == false then return false end
	end
	return true
end

function jps.totalAttackPower()
	local base, pos, neg = UnitAttackPower("player")
	return base + pos + neg
end

function jps.shouldRefreshDot(dotName, unit)
	if not unit then unit = "target" end
	local ap = jps.totalAttackPower()
	local crit = GetCritChance()
	local dmgBuff = jps.getDamageBuff()
	local mastery = GetMastery()
	local dotID = nil
	if type(dotName) == "number" then
		dotID = dotName
	else
		dotID = jps.spells.deathknight[dotName]
	end
	local shouldRefresh = false
	if jps.currentDotStats[dotID] then
		if ap > jps.currentDotStats[dotID].ap then  shouldRefresh = true end
		if crit > jps.currentDotStats[dotID].crit then  shouldRefresh = true end
		if dmgBuff > jps.currentDotStats[dotID].dmgBuff then  shouldRefresh = true end
		if mastery > jps.currentDotStats[dotID].mastery then
			if jps.Spec == "Unholy" and dotID == 55095 then  shouldRefresh = true end
			if jps.Spec == "Frost" and dotID == 55078 then  shouldRefresh = true end
		end
	end
	if shouldRefresh == true then
		jps.currentDotStats[dotID].isStrong = true
	end
	return shouldRefresh
end

function jps.shouldExtendDot(dotName, unit)
	if not unit then unit = "target" end
	if not jps.buff(dotName, unit) then return false end -- we can't extend dots which are not available
	if type(dotName) == "number" then
		local spellId = dotName
	else
		local spellId = jps.spells.deathknight[dotName] or nil
	end
	if not jps.shouldRefreshDot(spellID, unit) and jps.currentDotStats[spellID].isStrong then return true end -- extend current "strong" dot's
	return false
end

jps.dmgIncreaseBuffs = {
	{138002, 0.4}, --+40% jin rokh fluidity
	{140741, 1,0.1, "HARMFUL"},-- +100% +10% per stack - ji kun nitrument
	{57934, 0.15}, -- +15% - tricks
	{118977, 0.6},-- +60% - fearless
}

function jps.getDamageBuff()
	-- credits to kirk' dotTracker
	local damageBuff = 1
	for i=1,#jps.dmgIncreaseBuffs do -- for i, buff in ipairs(jps.dmgIncreaseBuffs) do
		local buff = jps.dmgIncreaseBuffs[i]
		local filter = buff[4] or nil
		hasBuff,_,_,stacks = UnitAura("player", buff[1], nil, filter)
		if hasBuff then
			damageBuff = damageBuff + buff[2] + (buff[2] * stacks)
		end
	end
	return damageBuff
end

jps.currentDotStats = {}
function jps.logDotDmg(...)
	local eventtype = select(2, ...)
	local srcName = select(5 , ...)
	local dotDmg = select(15, ...)
	local spellID = select(12, ...)
	local spellName = select(13, ...)

	if not eventtype then return end
	if spellName ~= jps.spells.deathknight.frostFever and spellName ~= jps.spells.deathknight.bloodPlague then return end
	if eventtype == "SPELL_AURA_APPLIED" or eventtype == "SPELL_AURA_REFRESH" then
		if not jps.currentDotStats[spellID] then jps.currentDotStats[spellID] = {} end
		jps.currentDotStats[spellID].ap = jps.totalAttackPower()
		jps.currentDotStats[spellID].mastery = GetMastery()
		jps.currentDotStats[spellID].crit = GetCritChance() -- since 5.2 also in the dot snapshot
		jps.currentDotStats[spellID].dmgBuff = jps.getDamageBuff()
		jps.currentDotStats[spellID].isStrong = false

	end
	if eventtype == "SPELL_AURA_REMOVED" then
		if jps.currentDotStats[spellID] then
			jps.currentDotStats[spellID].ap = 0
			jps.currentDotStats[spellID].mastery = 0
			jps.currentDotStats[spellID].crit = 0
			jps.currentDotStats[spellID].dmgBuff = 0
			jps.currentDotStats[spellID].isStrong = false
		end
	end
end
jps.listener.registerEvent("COMBAT_LOG_EVENT_UNFILTERED", jps.logDotDmg)